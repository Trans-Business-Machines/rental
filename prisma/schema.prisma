generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String       @id
  name          String
  email         String
  emailVerified Boolean
  image         String?
  role          String       @default("user")
  banned        Boolean      @default(false)
  banReason     String?
  banExpires    DateTime?
  createdAt     DateTime
  updatedAt     DateTime
  sessions      Session[]
  accounts      Account[]
  invitations   Invitation[] @relation("UserInvitations")
  invitedBy     Invitation[] @relation("InvitedBy")

  @@unique([email])
  @@map("user")
}

model Session {
  id             String   @id
  expiresAt      DateTime
  token          String
  createdAt      DateTime
  updatedAt      DateTime
  ipAddress      String?
  userAgent      String?
  userId         String
  impersonatedBy String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

model Property {
  id          Int       @id @default(autoincrement())
  name        String
  address     String
  type        String
  totalUnits  Int?
  occupied    Int       @default(0)
  rent        Int
  status      String    @default("active")
  description String
  image       String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  tenants     Tenant[]
  amenities   Amenity[]
  bookings    Booking[]
  units       Unit[]
  assignments InventoryAssignment[]

  @@map("properties")
}

model Unit {
  id         Int      @id @default(autoincrement())
  name       String // e.g., "Apartment 2A", "Studio 1C"
  propertyId Int
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  type       String // apartment, studio, condo, house
  status     String   @default("available") // available, occupied, maintenance
  rent       Int
  bedrooms   Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  bookings      Booking[]
  fromMovements InventoryMovement[]   @relation("FromUnit")
  toMovements   InventoryMovement[]   @relation("ToUnit")
  assignments   InventoryAssignment[]

  @@map("units")
}

model Tenant {
  id         Int      @id @default(autoincrement())
  name       String
  email      String
  phone      String
  unitNumber String
  leaseStart String
  leaseEnd   String
  rent       Int
  status     String   @default("active")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  propertyId Int
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("tenants")
}

model Amenity {
  id          Int      @id @default(autoincrement())
  name        String
  description String
  icon        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  properties Property[]

  @@map("amenities")
}

enum IdType {
  national_id
  passport
}

model Guest {
  id                       Int       @id @default(autoincrement())
  firstName                String
  lastName                 String
  email                    String
  phone                    String
  dateOfBirth              String
  nationality              String
  idType                   IdType    @default(national_id)
  idNumber                 String?
  passportNumber           String?
  notes                    String?
  address                  String?
  city                     String?
  country                  String?
  occupation               String?
  employer                 String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  registrationDate         DateTime? @default(now())
  lastStay                 DateTime?
  totalStays               Int?      @default(0)
  totalNights              Int?      @default(0)
  totalSpent               Int?      @default(0)
  rating                   Float?
  blacklisted              Boolean?  @default(false)
  verificationStatus       String?   @default("verified") // pending, verified, rejected
  createdAt                DateTime? @default(now())
  updatedAt                DateTime? @updatedAt

  bookings        Booking[]
  checkoutReports CheckoutReport[]

  @@map("guests")
}

model Booking {
  id              Int      @id @default(autoincrement())
  guestId         Int
  guest           Guest    @relation(fields: [guestId], references: [id], onDelete: Cascade)
  propertyId      Int
  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unitId          Int
  unit            Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  checkInDate     DateTime
  checkOutDate    DateTime
  numberOfGuests  Int
  totalAmount     Int
  source          String // direct, booking.com, airbnb, etc.
  purpose         String // business, leisure, etc.
  paymentMethod   String? // mpesa_till, credit_card, debit_card
  specialRequests String?
  status          String   @default("confirmed") // confirmed, checked-in, checked-out, cancelled
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  checkoutReport CheckoutReport?

  @@map("bookings")
}

model InventoryItem {
  id                  Int       @id @default(autoincrement())
  category            String // Furniture, Electronics, Appliances, etc.
  itemName            String
  description         String
  quantity            Int // Store quantity available for assignment
  purchasePrice       Int?
  currentValue        Int?
  supplier            String?
  warrantyExpiry      DateTime?
  status              String    @default("active") // active, discontinued
  assignableOnBooking Boolean   @default(true) // true = can be assigned to guests, false = fixed in room
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  checkoutItems CheckoutItem[]
  movements     InventoryMovement[]
  assignments   InventoryAssignment[]

  @@map("inventory_items")
}

model InventoryMovement {
  id              Int           @id @default(autoincrement())
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  inventoryItemId Int
  fromUnitId      Int?
  fromUnit        Unit?         @relation("FromUnit", fields: [fromUnitId], references: [id])
  toUnitId        Int?
  toUnit          Unit?         @relation("ToUnit", fields: [toUnitId], references: [id])
  movedBy         String
  movedAt         DateTime      @default(now())
  direction       String // "to_unit", "to_store"
  quantity        Int
  notes           String?

  @@map("inventory_movements")
}

model InventoryAssignment {
  id              Int           @id @default(autoincrement())
  inventoryItemId Int // Required - links to the inventory item
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  unitId          Int? // Optional - which unit it's assigned to
  unit            Unit?         @relation(fields: [unitId], references: [id], onDelete: Cascade)
  propertyId      Int? // Optional - which property it's assigned to
  property        Property?     @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  serialNumber    String? // Optional - unique identifier for this instance
  notes           String? // Optional - additional notes
  isActive        Boolean       @default(true) // Boolean to track if assignment is active
  assignedAt      DateTime      @default(now())
  returnedAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("inventory_assignments")
}

model CheckoutReport {
  id               Int      @id @default(autoincrement())
  bookingId        Int      @unique
  booking          Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  guestId          Int
  guest            Guest    @relation(fields: [guestId], references: [id], onDelete: Cascade)
  checkoutDate     DateTime
  inspector        String
  totalDamageCost  Int      @default(0)
  depositDeduction Int      @default(0)
  status           String   @default("completed") // completed, pending
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  checkoutItems CheckoutItem[]

  @@map("checkout_reports")
}

model CheckoutItem {
  id               Int            @id @default(autoincrement())
  checkoutReportId Int
  checkoutReport   CheckoutReport @relation(fields: [checkoutReportId], references: [id], onDelete: Cascade)
  inventoryItemId  Int
  inventoryItem    InventoryItem  @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  condition        String // good, damaged, missing
  damageCost       Int            @default(0)
  notes            String?
  createdAt        DateTime       @default(now())

  @@map("checkout_items")
}

model Invitation {
  id          String    @id @default(uuid())
  email       String    @unique
  name        String?
  role        String // 'user' or 'admin'
  token       String    @unique
  createdAt   DateTime  @default(now())
  acceptedAt  DateTime?
  userId      String? // The user created after accepting invite
  user        User?     @relation("UserInvitations", fields: [userId], references: [id])
  invitedById String? // The admin who sent the invite
  invitedBy   User?     @relation("InvitedBy", fields: [invitedById], references: [id])

  @@map("invitations")
}

model Media {
  id         String   @id @default(uuid())
  url        String
  key        String // S3 object key
  type       String // image/jpeg, image/png, etc.
  size       Int
  entityType String // e.g., "Property", "Unit"
  entityId   Int // ID of the associated entity
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("media")
}
